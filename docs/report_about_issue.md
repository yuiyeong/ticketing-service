# 가상 장애 대응 보고서

# 좌석 점유 및 예약 프로세스 부하 테스트 시나리오의 결과

![스크린샷 2024-08-23 오전 2.54.22.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/315950f2-a9dd-4897-a8e5-56c1bbdae102/43fe8e9a-861e-4237-9348-1d3cccecb4ca/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2024-08-23_%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB_2.54.22.png)

- 임계값(Thresholds) 결과
    - http_req_duration: 실패 (90%의 요청이 12.28초 이내 처리됨, 2초 미만 목표 실패)
    - http_req_failed: 실패 (에러율 0.12%, 0.1% 미만 목표 실패)
    - http_reqs: 통과 (초당 417개 요청 처리, 100개 이상 목표 달성)
    - checks: 실패 (99.56% 성공, 99.99% 이상 목표 실패)
    - data_integrity: 통과 (100% 성공, 100% 목표 달성)
- 설정한 SLO 를 달성하지 못 했습니다.

    ```jsx
    export const options = {
      thresholds: {
        // 응답속도: 90%의 요청이 2초 이내에 처리되어야 함
        http_req_duration: ['p(90)<2000'],
        // 에러율: 전체 요청의 0.1% 미만이어야 함
        http_req_failed: ['rate<0.001'],
        // 처리량: 초당 최소 100개의 요청을 처리해야 함
        http_reqs: ['rate>100'],
        // 가용성: 99.99% 이상의 요청이 성공해야 함
        checks: ['rate>0.9999'],
      },
    };
    ```

# 장애 대응 보고서

## 장애 발생 시간

- 2024년 08월 23일 오후 11시 23분

## 장애 인지 시간

- 2024년 08월 23일 오후 11시 30분

## 장애 해결 시간

- 2024년 08월 24일 오전 04시 00분

## 임팩트

- 콘서트 티켓 예약 시스템의 성능 저하 및 일부 사용자의 예약 실패
- 약 0.43%의 요청 실패율 발생
- 사용자 경험 저하 및 고객 불만 증가 가능성
- 시스템 신뢰도 하락 및 잠재적 수익 손실

## 원인

- 좌석 점유에 대한 만료 처리와 좌석 예약 프로세스 간의 경쟁 상태(Race Condition) 발생
- 동시에 여러 사용자가 같은 좌석을 점유하려 할 때 데드락(Dead Lock) 발생
- 트랜잭션 관리 및 동시성 제어 메커니즘의 미흡

## 장애 재발 방지 정책

### 숏텀

1. 즉시 조치
    - 데드락 감지 및 해제 메커니즘 강화
    - 좌석 점유 시간 제한 조정으로 경쟁 상태 발생 가능성 감소
2. 모니터링 강화
    - 실시간 데드락 모니터링 시스템 구축
    - 성능 메트릭 및 에러 로그 모니터링 강화
3. 롤백 계획 수립
    - 문제 발생 시 신속한 롤백이 가능하도록 계획 수립 및 테스트

### 미드텀

1. 코드 개선
    - 좌석 예약 로직 최적화
    - 트랜잭션 격리 수준 조정 및 세밀한 락 관리 구현
2. 아키텍처 개선
    - 분산 락 시스템 도입
    - 큐 시스템을 활용한 비동기 처리 방식 도입으로 동시 접근 제어
3. 테스트 강화
    - 동시성 관련 단위 테스트 및 통합 테스트 추가
    - 부하 테스트 시나리오 다양화 및 정기적인 실행

### 롱텀

1. 시스템 재설계
    - 마이크로서비스 아키텍처 도입 검토로 시스템 확장성 및 유연성 확보
    - 이벤트 소싱(Event Sourcing) 패턴 도입으로 데이터 일관성 및 추적성 강화
2. 인프라 개선
    - 클라우드 네이티브 기술 도입으로 자동 스케일링 및 장애 복구 능력 향상
    - 데이터베이스 샤딩 전략 수립으로 데이터 접근 경합 감소